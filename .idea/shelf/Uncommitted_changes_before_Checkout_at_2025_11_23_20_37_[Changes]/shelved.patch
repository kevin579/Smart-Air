Index: app/src/main/java/com/example/SmartAirGroup2/ParentDashboardFragment.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.example.SmartAirGroup2;\r\n\r\nimport android.annotation.SuppressLint;\r\nimport android.content.Context;\r\nimport android.content.SharedPreferences;\r\nimport android.graphics.Color;\r\nimport android.graphics.PorterDuff;\r\nimport android.graphics.drawable.Drawable;\r\nimport android.os.Bundle;\r\nimport android.util.Log;\r\nimport android.util.TypedValue;\r\nimport android.view.Gravity;\r\nimport android.view.LayoutInflater;\r\nimport android.view.Menu;\r\nimport android.view.MenuInflater;\r\nimport android.view.MenuItem;\r\nimport android.view.View;\r\nimport android.view.ViewGroup;\r\nimport android.widget.FrameLayout;\r\nimport android.widget.ImageView;\r\nimport android.widget.LinearLayout;\r\nimport android.widget.TextView;\r\nimport android.widget.Toast;\r\n\r\nimport androidx.annotation.NonNull;\r\nimport androidx.annotation.Nullable;\r\nimport androidx.appcompat.app.AlertDialog;\r\nimport androidx.appcompat.app.AppCompatActivity;\r\nimport androidx.appcompat.widget.Toolbar;\r\nimport androidx.cardview.widget.CardView;\r\nimport androidx.core.content.ContextCompat;\r\nimport androidx.fragment.app.Fragment;\r\nimport androidx.fragment.app.FragmentTransaction;\r\n\r\nimport com.google.firebase.database.DataSnapshot;\r\nimport com.google.firebase.database.DatabaseError;\r\nimport com.google.firebase.database.DatabaseReference;\r\nimport com.google.firebase.database.FirebaseDatabase;\r\nimport com.google.firebase.database.ValueEventListener;\r\n\r\nimport java.util.ArrayList;\r\nimport java.util.List;\r\n\r\n/**\r\n * ParentDashboardFragment\r\n * -----------------------\r\n * This fragment serves as the primary dashboard for parent users within the Smart Air application.\r\n * It provides an overview of all linked child accounts and enables parents to perform account\r\n * management actions.\r\n *\r\n * Core User Actions:\r\n *   • View all children currently linked to their account.\r\n *   • Add a new child or link an existing child account.\r\n *   • Remove/unlink a child account when needed.\r\n *   • Navigate to individual child dashboards for detailed monitoring.\r\n *\r\n * UI Behavior:\r\n *   - The fragment dynamically generates CardViews representing each linked child.\r\n *   - Each card displays:\r\n *       • Child name (or username if name unavailable)\r\n *       • Status indicator (color-coded background)\r\n *       • A delete icon to allow unlinking\r\n *   - If no children are linked, only the \"Add Child\" card is displayed.\r\n *   - Cards use ripple effects for modern touch feedback.\r\n *\r\n * Firebase Structure (Relevant Paths):\r\n * └── categories/\r\n *     └── users/\r\n *         ├── parents/{parentUname}/children/{childUname: String}\r\n *         └── children/{childUname}/\r\n *             ├── name: String\r\n *             ├── uname: String\r\n *             └── status/{individual status: Integer}\r\n *\r\n * Status Logic:\r\n *   - The background color of each child card reflects their status history:\r\n *       • Red (alert color) → Contains alert values (1 or 2 detected)\r\n *       • Green (good color) → No concerning status entries\r\n *   - Status values are retrieved from the child's status history in Firebase.\r\n *\r\n * Fragment Lifecycle Responsibilities:\r\n *   ✔ Initialize toolbar and UI components\r\n *   ✔ Fetch Firebase data for linked children\r\n *   ✔ Listen for child database changes\r\n *   ✔ Dynamically create UI elements based on data\r\n *   ✔ Persist login metadata using SharedPreferences\r\n *   ✔ Handle user interactions (navigation, deletion, linking)\r\n *\r\n * Navigation:\r\n *   - Tapping a child card navigates to ChildDashboardFragment with child details.\r\n *   - Tapping \"Add Child\" opens a dialog prompting:\r\n *        → \"Yes\": Navigate to LinkChildFragment (for existing accounts)\r\n *        → \"No\" : Navigate to AddChildFragment (for new accounts)\r\n *\r\n * Dependencies:\r\n *   • Firebase Realtime Database for user and relationship data.\r\n *   • SharedPreferences for user type and logged-in identity persistence.\r\n *   • MenuHelper for toolbar menu operations.\r\n *   • User model class for child data representation.\r\n *\r\n * Author: Kevin Li\r\n * Last Updated: November 18 2025\r\n */\r\npublic class ParentDashboardFragment extends Fragment {\r\n\r\n    // ═══════════════════════════════════════════════════════════════════════\r\n    // UI COMPONENTS\r\n    // ═══════════════════════════════════════════════════════════════════════\r\n\r\n    /**\r\n     * Toolbar component displayed at the top of the fragment.\r\n     * Provides navigation and menu actions for the parent user.\r\n     */\r\n    private Toolbar toolbar;\r\n\r\n    /**\r\n     * CardView for the \"Add Child\" button.\r\n     * Always displayed at the bottom of the children list.\r\n     */\r\n    private CardView cardAddChild;\r\n\r\n    /**\r\n     * Container that holds all dynamically generated child cards.\r\n     * Children are added/removed from this layout based on Firebase data.\r\n     */\r\n    private LinearLayout contentContainer;\r\n\r\n    // ═══════════════════════════════════════════════════════════════════════\r\n    // FIREBASE REFERENCES\r\n    // ═══════════════════════════════════════════════════════════════════════\r\n\r\n    /**\r\n     * Firebase Database instance pointing to the Smart Air database.\r\n     * Used to initialize all database references.\r\n     */\r\n    private FirebaseDatabase db;\r\n\r\n    /**\r\n     * Database reference to the parent's children node.\r\n     * Path: categories/users/parents/{uname}/children\r\n     * Contains all child usernames linked to this parent.\r\n     */\r\n    private DatabaseReference childrenRef;\r\n\r\n    // ═══════════════════════════════════════════════════════════════════════\r\n    // USER IDENTITY\r\n    // ═══════════════════════════════════════════════════════════════════════\r\n\r\n    /**\r\n     * Username of the currently logged-in parent.\r\n     * TODO: Replace hardcoded value with dynamic authentication.\r\n     */\r\n    private String uname = \"kevin579\";\r\n\r\n    /**\r\n     * User type identifier for the current user.\r\n     * Always \"parent\" for this fragment.\r\n     */\r\n    private String type = \"parent\";\r\n\r\n    private boolean safetyAlert = false;\r\n\r\n    private View notificationActionView;\r\n    private View notificationBadge;\r\n\r\n\r\n    // ═══════════════════════════════════════════════════════════════════════\r\n    // LIFECYCLE METHODS\r\n    // ═══════════════════════════════════════════════════════════════════════\r\n\r\n    public static ParentDashboardFragment newInstance(String username) {\r\n        ParentDashboardFragment fragment = new ParentDashboardFragment();\r\n        Bundle args = new Bundle();\r\n        args.putString(\"username\", username);\r\n        fragment.setArguments(args);\r\n        return fragment;\r\n    }\r\n    /**\r\n     * Creates and initializes the view hierarchy for this fragment.\r\n     *\r\n     * Responsibilities:\r\n     *   - Inflates the parent dashboard layout\r\n     *   - Sets up the toolbar with menu support\r\n     *   - Initializes Firebase database references\r\n     *   - Loads children data from Firebase\r\n     *   - Persists user identity to SharedPreferences\r\n     *   - Configures \"Add Child\" button click handler\r\n     *\r\n     * @param inflater           LayoutInflater to inflate the view\r\n     * @param container          Parent view that this fragment's UI will be attached to\r\n     * @param savedInstanceState Previously saved state, if any\r\n     * @return                   The root view for this fragment\r\n     */\r\n    @Nullable\r\n    @Override\r\n    public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState) {\r\n        View view = inflater.inflate(R.layout.fragment_parent_dashboard, container, false);\r\n\r\n        // ─────────────────────────────────────────────────────────────────\r\n        // Toolbar Configuration\r\n        // ─────────────────────────────────────────────────────────────────\r\n        toolbar = view.findViewById(R.id.toolbar);\r\n        ((AppCompatActivity) getActivity()).setSupportActionBar(toolbar);\r\n        setHasOptionsMenu(true);\r\n\r\n        // ─────────────────────────────────────────────────────────────────\r\n        // UI Component Initialization\r\n        // ─────────────────────────────────────────────────────────────────\r\n        contentContainer = view.findViewById(R.id.contentContainer);\r\n        cardAddChild = view.findViewById(R.id.cardAddChild);\r\n\r\n        // ─────────────────────────────────────────────────────────────────\r\n        // Firebase Initialization\r\n        // ─────────────────────────────────────────────────────────────────\r\n        db = FirebaseDatabase.getInstance(\"https://smart-air-group2-default-rtdb.firebaseio.com/\");\r\n        childrenRef = db.getReference(\"categories/users/parents/\" + uname + \"/children\");\r\n\r\n\r\n        // ─────────────────────────────────────────────────────────────────\r\n        // Load Children Data\r\n        // ─────────────────────────────────────────────────────────────────\r\n        loadChildrenFromDatabase();\r\n\r\n        // ─────────────────────────────────────────────────────────────────\r\n        // Persist User Identity\r\n        // ─────────────────────────────────────────────────────────────────\r\n        SharedPreferences prefs = requireContext().getSharedPreferences(\"APP_DATA\", Context.MODE_PRIVATE);\r\n        prefs.edit().putString(\"parentUname\", uname).apply();\r\n        prefs.edit().putString(\"type\", type).apply();\r\n\r\n        // ─────────────────────────────────────────────────────────────────\r\n        // Add Child Button Handler\r\n        // ─────────────────────────────────────────────────────────────────\r\n        // Shows a dialog asking if the child already has an account:\r\n        //   - \"Yes\" → Navigate to LinkChildFragment\r\n        //   - \"No\"  → Navigate to AddChildFragment\r\n        cardAddChild.setOnClickListener(v -> {\r\n            new AlertDialog.Builder(requireContext())\r\n                    .setTitle(\"Confirm Action\")\r\n                    .setMessage(\"Does your child already have an account?\")\r\n                    .setPositiveButton(\"Yes\", (dialog, which) -> {\r\n                        // Navigate to link existing child\r\n                        LinkChildFragment linkFrag = new LinkChildFragment();\r\n                        Bundle args = new Bundle();\r\n                        args.putString(\"parentUname\", uname);\r\n                        linkFrag.setArguments(args);\r\n                        loadFragment(linkFrag);\r\n                    })\r\n                    .setNegativeButton(\"No\", (dialog, which) -> {\r\n                        // Navigate to create new child\r\n                        AddChildFragment addFrag = new AddChildFragment();\r\n                        Bundle args = new Bundle();\r\n                        args.putString(\"parentUname\", uname);\r\n                        addFrag.setArguments(args);\r\n                        loadFragment(addFrag);\r\n                        dialog.dismiss();\r\n                    })\r\n                    .show();\r\n        });\r\n\r\n        return view;\r\n    }\r\n\r\n\r\n    // ═══════════════════════════════════════════════════════════════════════\r\n    // FIREBASE DATA LOADING\r\n    // ═══════════════════════════════════════════════════════════════════════\r\n\r\n    /**\r\n     * Loads all children linked to the current parent from Firebase.\r\n     *\r\n     * Process:\r\n     *   1. Queries the parent's children node for all linked usernames\r\n     *   2. For each child username:\r\n     *      a. Fetches child details (name, username)\r\n     *      b. Fetches child status history\r\n     *      c. Creates a CardView with appropriate color coding\r\n     *   3. Ensures \"Add Child\" card is added after all children load\r\n     *   4. Displays toast if no children are found\r\n     *\r\n     * Color Coding:\r\n     *   - Red (alert) if status contains 1 or 2\r\n     *   - Green (good) otherwise\r\n     *\r\n     * Threading:\r\n     *   - Uses Firebase's asynchronous listeners\r\n     *   - Tracks completion count to ensure \"Add Child\" appears last\r\n     */\r\n    private void loadChildrenFromDatabase() {\r\n\r\n        childrenRef.addListenerForSingleValueEvent(new ValueEventListener() {\r\n            @Override\r\n            public void onDataChange(@NonNull DataSnapshot snapshot) {\r\n                // Validate fragment and context availability\r\n                if (contentContainer == null || getContext() == null) return;\r\n\r\n                // Clear existing views\r\n                contentContainer.removeAllViews();\r\n                int totalChildren = (int) snapshot.getChildrenCount();\r\n\r\n                // Handle case with no children\r\n                if (totalChildren == 0) {\r\n                    contentContainer.addView(cardAddChild);\r\n                    Toast.makeText(getContext(), \"No children linked yet\", Toast.LENGTH_SHORT).show();\r\n                    return;\r\n                }\r\n\r\n                // Track loading progress to ensure \"Add Child\" button appears last\r\n                final int[] loadedChildren = {0};\r\n                final int[] completedStatusLoads = {0};\r\n\r\n                // Iterate through each child username\r\n                for (DataSnapshot childSnapshot : snapshot.getChildren()) {\r\n                    String childUname = childSnapshot.getValue(String.class);\r\n\r\n                    // Skip invalid entries\r\n                    if (childUname == null || childUname.isEmpty()) {\r\n                        loadedChildren[0]++;\r\n                        completedStatusLoads[0]++;\r\n                        if (completedStatusLoads[0] == totalChildren)\r\n                            contentContainer.addView(cardAddChild);\r\n                        continue;\r\n                    }\r\n\r\n                    // Reference to child's data node\r\n                    DatabaseReference childRef = FirebaseDatabase.getInstance()\r\n                            .getReference(\"categories/users/children\")\r\n                            .child(childUname);\r\n\r\n                    // Fetch child details\r\n                    childRef.addListenerForSingleValueEvent(new ValueEventListener() {\r\n                        @Override\r\n                        public void onDataChange(@NonNull DataSnapshot childData) {\r\n                            if (childData.exists()) {\r\n                                User child = childData.getValue(User.class);\r\n                                if (child != null) {\r\n                                    // Determine display name (prefer full name over username)\r\n                                    String displayName = (child.getName() != null && !child.getName().isEmpty())\r\n                                            ? child.getName()\r\n                                            : child.getUname();\r\n\r\n                                    // Fetch status history for color coding\r\n                                    DatabaseReference statusRef = FirebaseDatabase.getInstance()\r\n                                            .getReference(\"categories/users/children\")\r\n                                            .child(child.getUname())\r\n                                            .child(\"status\");\r\n\r\n                                    statusRef.addListenerForSingleValueEvent(new ValueEventListener() {\r\n                                        @Override\r\n                                        public void onDataChange(@NonNull DataSnapshot statusSnap) {\r\n\r\n                                            Integer pefZone = statusSnap.child(\"pefZone\").getValue(Integer.class);\r\n                                            if (!safetyAlert && pefZone != null && pefZone == 2) {\r\n                                                safetyAlert = true;\r\n                                                showSafetyAlertDialog(child.getUname(), displayName);\r\n                                            }\r\n\r\n                                            // Parse status values from Firebase\r\n                                            List<Integer> statusList = new ArrayList<>();\r\n\r\n                                            if (statusSnap.exists()) {\r\n                                                extractStatusValues(statusSnap, statusList);\r\n                                            }\r\n\r\n                                            // Create child card with status-based color\r\n                                            addChildCard(displayName, child.getUname(), statusList);\r\n\r\n                                            // Check if all children loaded\r\n                                            completedStatusLoads[0]++;\r\n                                            if (completedStatusLoads[0] == totalChildren)\r\n                                                contentContainer.addView(cardAddChild);\r\n                                        }\r\n\r\n                                        @Override\r\n                                        public void onCancelled(@NonNull DatabaseError error) {\r\n                                            // Show card with default color on error\r\n                                            addChildCard(displayName, child.getUname(), new ArrayList<>());\r\n\r\n                                            completedStatusLoads[0]++;\r\n                                            if (completedStatusLoads[0] == totalChildren)\r\n                                                contentContainer.addView(cardAddChild);\r\n                                        }\r\n                                    });\r\n                                } else {\r\n                                    // Child data is null\r\n                                    completedStatusLoads[0]++;\r\n                                    if (completedStatusLoads[0] == totalChildren)\r\n                                        contentContainer.addView(cardAddChild);\r\n                                }\r\n                            } else {\r\n                                // Child doesn't exist in database\r\n                                completedStatusLoads[0]++;\r\n                                if (completedStatusLoads[0] == totalChildren)\r\n                                    contentContainer.addView(cardAddChild);\r\n                            }\r\n\r\n                            loadedChildren[0]++;\r\n                        }\r\n\r\n                        @Override\r\n                        public void onCancelled(@NonNull DatabaseError error) {\r\n                            loadedChildren[0]++;\r\n                            completedStatusLoads[0]++;\r\n                            if (completedStatusLoads[0] == totalChildren)\r\n                                contentContainer.addView(cardAddChild);\r\n                        }\r\n                    });\r\n                }\r\n            }\r\n\r\n            @Override\r\n            public void onCancelled(@NonNull DatabaseError error) {\r\n                Log.e(\"FIREBASE\", \"Error: \" + error.getMessage());\r\n            }\r\n        });\r\n    }\r\n\r\n    /*\r\n    This helper method is used the get all the status code\r\n     */\r\n    private void extractStatusValues(DataSnapshot snap, List<Integer> result) {\r\n        for (DataSnapshot child : snap.getChildren()) {\r\n            Object val = child.getValue();\r\n\r\n            // Case 1: It's a direct integer\r\n            if (val instanceof Long || val instanceof Integer) {\r\n                result.add(((Number) val).intValue());\r\n            }\r\n\r\n            // Case 2: Nested object → go deeper\r\n            else if (child.hasChildren()) {\r\n                extractStatusValues(child, result);\r\n            }\r\n        }\r\n    }\r\n    private void showSafetyAlertDialog(String childUname, String childDisplayName) {\r\n        if (!isAdded() || getContext() == null) return;\r\n\r\n        new AlertDialog.Builder(requireContext())\r\n                .setTitle(\"Safety Alert\")\r\n                .setMessage(\"Your child is in the red PEF zone. Please check their asthma status.\")\r\n                .setPositiveButton(\"View alerts\", (dialog, which) -> {\r\n                    AlertCenterFragment alertFrag = new AlertCenterFragment();\r\n                    Bundle args = new Bundle();\r\n                    args.putString(\"parentUname\", uname);\r\n                    alertFrag.setArguments(args);\r\n\r\n                    getParentFragmentManager()\r\n                            .beginTransaction()\r\n                            .replace(R.id.fragment_container, alertFrag)\r\n                            .addToBackStack(null)\r\n                            .commit();\r\n                })\r\n                .setNegativeButton(\"Dismiss\", null)\r\n                .show();\r\n    }\r\n\r\n\r\n    // ═══════════════════════════════════════════════════════════════════════\r\n    // UI CONSTRUCTION HELPERS\r\n    // ═══════════════════════════════════════════════════════════════════════\r\n\r\n    /**\r\n     * Dynamically creates and adds a CardView for a linked child.\r\n     *\r\n     * Card Features:\r\n     *   - Displays child's name (or username as fallback)\r\n     *   - Color-coded background based on status:\r\n     *       • Red if status list contains 1 or 2 (alert)\r\n     *       • Green otherwise (good)\r\n     *   - Delete icon for unlinking the child\r\n     *   - Ripple effect for touch feedback\r\n     *   - Navigates to ChildDashboardFragment on click\r\n     *\r\n     * @param childName   Display name of the child\r\n     * @param childKey    Username/key of the child in Firebase\r\n     * @param statusList  List of status values for determining card color\r\n     */\r\n    @SuppressLint(\"ResourceType\")\r\n    private void addChildCard(String childName, String childKey, List<Integer> statusList) {\r\n        // Validate fragment state\r\n        if (!isAdded() || getContext() == null) return;\r\n        Context ctx = requireContext();\r\n\r\n        // ─────────────────────────────────────────────────────────────────\r\n        // Create CardView Container\r\n        // ─────────────────────────────────────────────────────────────────\r\n        CardView cardView = new CardView(ctx);\r\n        LinearLayout.LayoutParams cardParams = new LinearLayout.LayoutParams(\r\n                LinearLayout.LayoutParams.MATCH_PARENT,\r\n                LinearLayout.LayoutParams.WRAP_CONTENT\r\n        );\r\n        cardParams.setMargins(0, 0, 0, dpToPx(16));\r\n        cardView.setLayoutParams(cardParams);\r\n\r\n        // ─────────────────────────────────────────────────────────────────\r\n        // Set Background Color Based on Status\r\n        // ─────────────────────────────────────────────────────────────────\r\n        if (statusList.contains(2)) {\r\n            cardView.setCardBackgroundColor(ContextCompat.getColor(getContext(), R.color.alert));\r\n        } else if (statusList.contains(1)) {\r\n            cardView.setCardBackgroundColor(ContextCompat.getColor(getContext(), R.color.alert));\r\n        } else {\r\n            cardView.setCardBackgroundColor(ContextCompat.getColor(getContext(), R.color.good));\r\n        }\r\n\r\n        cardView.setRadius(dpToPx(8));\r\n        cardView.setCardElevation(0);\r\n        cardView.setClickable(true);\r\n        cardView.setFocusable(true);\r\n\r\n        // ─────────────────────────────────────────────────────────────────\r\n        // Add Ripple Effect\r\n        // ─────────────────────────────────────────────────────────────────\r\n        TypedValue outValue = new TypedValue();\r\n        if (ctx.getTheme().resolveAttribute(android.R.attr.selectableItemBackground, outValue, true)) {\r\n            Drawable selectable = ContextCompat.getDrawable(ctx, outValue.resourceId);\r\n            if (selectable != null) cardView.setForeground(selectable);\r\n        }\r\n\r\n        // ─────────────────────────────────────────────────────────────────\r\n        // Create Inner Layout\r\n        // ─────────────────────────────────────────────────────────────────\r\n        LinearLayout innerLayout = new LinearLayout(ctx);\r\n        innerLayout.setOrientation(LinearLayout.HORIZONTAL);\r\n        innerLayout.setLayoutParams(new FrameLayout.LayoutParams(\r\n                FrameLayout.LayoutParams.MATCH_PARENT,\r\n                FrameLayout.LayoutParams.WRAP_CONTENT\r\n        ));\r\n        innerLayout.setPadding(dpToPx(16), dpToPx(16), dpToPx(16), dpToPx(16));\r\n        innerLayout.setGravity(Gravity.CENTER_VERTICAL);\r\n\r\n        // ─────────────────────────────────────────────────────────────────\r\n        // Child Name TextView\r\n        // ─────────────────────────────────────────────────────────────────\r\n        TextView textView = new TextView(ctx);\r\n        textView.setLayoutParams(new LinearLayout.LayoutParams(0, LinearLayout.LayoutParams.WRAP_CONTENT, 1f));\r\n        textView.setText(childName);\r\n        textView.setTextSize(18);\r\n\r\n        // ─────────────────────────────────────────────────────────────────\r\n        // Delete Icon\r\n        // ─────────────────────────────────────────────────────────────────\r\n        ImageView deleteView = new ImageView(ctx);\r\n        LinearLayout.LayoutParams imgParams = new LinearLayout.LayoutParams(dpToPx(24), dpToPx(24));\r\n        imgParams.setMarginEnd(dpToPx(12));\r\n        deleteView.setLayoutParams(imgParams);\r\n        deleteView.setImageResource(android.R.drawable.ic_delete);\r\n        deleteView.setColorFilter(ContextCompat.getColor(ctx, R.color.delete), PorterDuff.Mode.SRC_IN);\r\n\r\n\r\n\r\n        // ─────────────────────────────────────────────────────────────────\r\n        // Assemble Card\r\n        // ─────────────────────────────────────────────────────────────────\r\n        innerLayout.addView(textView);\r\n        innerLayout.addView(deleteView);\r\n        cardView.addView(innerLayout);\r\n\r\n        // ─────────────────────────────────────────────────────────────────\r\n        // Card Click Handler - Navigate to Child Dashboard\r\n        // ─────────────────────────────────────────────────────────────────\r\n        cardView.setOnClickListener(v -> {\r\n            Bundle args = new Bundle();\r\n            args.putString(\"childUname\", childKey);\r\n            args.putString(\"childName\", childName);\r\n\r\n            ChildDashboardFragment childFrag = new ChildDashboardFragment();\r\n            childFrag.setArguments(args);\r\n            loadFragment(childFrag);\r\n        });\r\n\r\n        // ─────────────────────────────────────────────────────────────────\r\n        // Delete Icon Click Handler - Unlink Child\r\n        // ─────────────────────────────────────────────────────────────────\r\n        deleteView.setOnClickListener(v -> {\r\n            if (!isAdded()) return;\r\n\r\n            new AlertDialog.Builder(requireContext())\r\n                    .setTitle(\"Remove Child\")\r\n                    .setMessage(\"Are you sure you want to unlink \" + childName + \"?\")\r\n                    .setPositiveButton(\"Yes\", (d, w) -> {\r\n                        if (childrenRef != null) {\r\n                            childrenRef.child(childKey).removeValue();\r\n                            Toast.makeText(ctx, \"Child removed\", Toast.LENGTH_SHORT).show();\r\n                            loadChildrenFromDatabase(); // Refresh view\r\n                        }\r\n                    })\r\n                    .setNegativeButton(\"No\", null)\r\n                    .show();\r\n        });\r\n\r\n        // ─────────────────────────────────────────────────────────────────\r\n        // Add Card to Container\r\n        // ─────────────────────────────────────────────────────────────────\r\n        if (cardView.getParent() == null)\r\n            contentContainer.addView(cardView);\r\n    }\r\n\r\n    /**\r\n     * Converts density-independent pixels (dp) to actual pixels (px).\r\n     * Ensures consistent UI spacing across different screen densities.\r\n     *\r\n     * @param dp Value in density-independent pixels\r\n     * @return   Equivalent value in pixels for the current device\r\n     */\r\n    private int dpToPx(int dp) {\r\n        float density = getResources().getDisplayMetrics().density;\r\n        return Math.round(dp * density);\r\n    }\r\n\r\n    // ═══════════════════════════════════════════════════════════════════════\r\n    // MENU HANDLING\r\n    // ═══════════════════════════════════════════════════════════════════════\r\n\r\n    /**\r\n     * Inflates the toolbar menu using MenuHelper.\r\n     * Called by the Android framework when the menu is being created.\r\n     *\r\n     * @param menu     Menu object to be populated\r\n     * @param inflater MenuInflater to use for inflating menu resources\r\n     */\r\n    @Override\r\n    public void onCreateOptionsMenu(@NonNull Menu menu, @NonNull MenuInflater inflater) {\r\n        super.onCreateOptionsMenu(menu, inflater);\r\n\r\n        MenuHelper.setupMenu(menu, inflater, requireContext());\r\n\r\n        MenuItem notifItem = menu.findItem(R.id.action_notifications);\r\n        if (notifItem != null) {\r\n            notificationActionView = notifItem.getActionView();\r\n            if (notificationActionView != null) {\r\n                notificationBadge = notificationActionView.findViewById(R.id.viewBadge);\r\n\r\n                notificationActionView.setOnClickListener(v -> onOptionsItemSelected(notifItem));\r\n            }\r\n        }\r\n        checkAlertsAndUpdateBadge();\r\n    }\r\n    private void updateNotificationBadge(boolean hasAlerts) {\r\n        if (notificationBadge == null) return;\r\n        notificationBadge.setVisibility(hasAlerts ? View.VISIBLE : View.GONE);\r\n    }\r\n\r\n    private void checkAlertsAndUpdateBadge() {\r\n        if (db == null) {\r\n            db = FirebaseDatabase.getInstance(\"https://smart-air-group2-default-rtdb.firebaseio.com/\");\r\n        }\r\n\r\n        DatabaseReference parentChildrenRef = db.getReference(\"categories/users/parents\")\r\n                .child(uname)\r\n                .child(\"children\");\r\n\r\n        parentChildrenRef.addListenerForSingleValueEvent(new ValueEventListener() {\r\n            @Override\r\n            public void onDataChange(@NonNull DataSnapshot snapshot) {\r\n                if (!snapshot.exists() || snapshot.getChildrenCount() == 0) {\r\n                    updateNotificationBadge(false);\r\n                    return;\r\n                }\r\n\r\n                int totalChildren = (int) snapshot.getChildrenCount();\r\n                final int[] finished = {0};\r\n                final boolean[] hasAlerts = {false};\r\n\r\n                for (DataSnapshot childSnap : snapshot.getChildren()) {\r\n                    String childUname = childSnap.getValue(String.class);\r\n\r\n                    if (childUname == null || childUname.trim().isEmpty()) {\r\n                        if (++finished[0] == totalChildren && !hasAlerts[0]) {\r\n                            updateNotificationBadge(false);\r\n                        }\r\n                        continue;\r\n                    }\r\n\r\n                    DatabaseReference statusRef = db.getReference(\"categories/users/children\")\r\n                            .child(childUname)\r\n                            .child(\"status\");\r\n\r\n                    statusRef.addListenerForSingleValueEvent(new ValueEventListener() {\r\n                        @Override\r\n                        public void onDataChange(@NonNull DataSnapshot statusSnap) {\r\n                            if (!hasAlerts[0]) {\r\n                                if (statusHasAlert(statusSnap)) {\r\n                                    hasAlerts[0] = true;\r\n                                    updateNotificationBadge(true);\r\n                                }\r\n                            }\r\n\r\n                            if (++finished[0] == totalChildren && !hasAlerts[0]) {\r\n                                updateNotificationBadge(false);\r\n                            }\r\n                        }\r\n\r\n                        @Override\r\n                        public void onCancelled(@NonNull DatabaseError error) {\r\n                            if (++finished[0] == totalChildren && !hasAlerts[0]) {\r\n                                updateNotificationBadge(false);\r\n                            }\r\n                        }\r\n                    });\r\n                }\r\n            }\r\n\r\n            @Override\r\n            public void onCancelled(@NonNull DatabaseError error) {\r\n                updateNotificationBadge(false);\r\n            }\r\n        });\r\n    }\r\n\r\n\r\n    private boolean statusHasAlert(DataSnapshot statusSnap) {\r\n        if (statusSnap == null || !statusSnap.exists()) {\r\n            return false;\r\n        }\r\n\r\n        // PEF red zone\r\n        Integer pefZone = statusSnap.child(\"pefZone\").getValue(Integer.class);\r\n        if (pefZone != null && pefZone == 2) {\r\n            return true;\r\n        }\r\n\r\n        DataSnapshot invSnap = statusSnap.child(\"inventory\");\r\n        if (invSnap != null && invSnap.exists()) {\r\n            for (DataSnapshot medSnap : invSnap.getChildren()) {\r\n                for (DataSnapshot snapIndex : medSnap.getChildren()) {\r\n                    Integer code = snapIndex.getValue(Integer.class);\r\n                    if (code != null && (code == 1 || code == 2)) {\r\n                        return true;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return false;\r\n    }\r\n\r\n\r\n\r\n    /**\r\n         * Handles menu item selection events.\r\n         * Delegates to MenuHelper for consistent menu behavior across the app.\r\n         *\r\n         * @param item The menu item that was selected\r\n         * @return     true if the event was handled, false otherwise\r\n         */\r\n    @Override\r\n    public boolean onOptionsItemSelected(@NonNull MenuItem item) {\r\n        if (MenuHelper.handleMenuSelection(item, this)) {\r\n            return true;\r\n        }\r\n        return super.onOptionsItemSelected(item);\r\n    }\r\n\r\n    // ═══════════════════════════════════════════════════════════════════════\r\n    // FRAGMENT NAVIGATION\r\n    // ═══════════════════════════════════════════════════════════════════════\r\n\r\n    /**\r\n     * Navigates to another fragment within the same activity.\r\n     * Adds the transaction to the back stack for back button support.\r\n     *\r\n     * @param fragment The fragment to navigate to\r\n     */\r\n    private void loadFragment(Fragment fragment) {\r\n        FragmentTransaction transaction = getParentFragmentManager().beginTransaction();\r\n        transaction.replace(R.id.fragment_container, fragment);\r\n        transaction.addToBackStack(null);\r\n        transaction.commit();\r\n    }\r\n}\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/example/SmartAirGroup2/ParentDashboardFragment.java b/app/src/main/java/com/example/SmartAirGroup2/ParentDashboardFragment.java
--- a/app/src/main/java/com/example/SmartAirGroup2/ParentDashboardFragment.java	(revision fcc1e9007e3c7d06398885f53afd54399a56ea6d)
+++ b/app/src/main/java/com/example/SmartAirGroup2/ParentDashboardFragment.java	(date 1763946212784)
@@ -732,12 +732,10 @@
                 }
             }
         }
-
         return false;
     }
 
 
-
     /**
          * Handles menu item selection events.
          * Delegates to MenuHelper for consistent menu behavior across the app.
